name: Stack inventory for all repos

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1" # every Monday 03:00 UTC

permissions:
  contents: write

jobs:
  scan-stacks:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      GH_ORG: yosefhayim # set to your user/org name
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure jq is installed
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: List and scan all repos
        run: |
          set -euo pipefail

          ORG="${GH_ORG}"
          OUT="stack-report.json"

          echo "[]" > "$OUT"

          echo "Fetching repos for $ORG..."
          repos=$(gh repo list "$ORG" --limit 200 --json name -q '.[].name')

          for repo in $repos; do
            echo "Scanning $ORG/$repo"

            tmpdir=$(mktemp -d)
            git clone --depth 1 "https://github.com/$ORG/$repo.git" "$tmpdir" >/dev/null 2>&1 || {
              echo "  clone failed, skipping"
              rm -rf "$tmpdir"
              continue
            }

            stack="unknown"

            # Node / JS / TS: package.json
            if [ -f "$tmpdir/package.json" ]; then
              stack="nodejs"
              if jq -e '.dependencies.react // .devDependencies.react' "$tmpdir/package.json" >/dev/null 2>&1; then
                stack="${stack}+react"
              fi
              if jq -e '.dependencies.typescript // .devDependencies.typescript' "$tmpdir/package.json" >/dev/null 2>&1; then
                stack="${stack}+typescript"
              fi

            # Python
            elif [ -f "$tmpdir/requirements.txt" ] || ls "$tmpdir"/*.py >/dev/null 2>&1; then
              stack="python"

            # Go
            elif [ -f "$tmpdir/go.mod" ] || ls "$tmpdir"/*.go >/dev/null 2>&1; then
              stack="go"

            # Java
            elif [ -f "$tmpdir/pom.xml" ] || [ -f "$tmpdir/build.gradle" ] || [ -f "$tmpdir/build.gradle.kts" ]; then
              stack="java"

            # .NET
            elif ls "$tmpdir"/*.csproj >/dev/null 2>&1 || ls "$tmpdir"/*.sln >/dev/null 2>&1; then
              stack="dotnet"
            fi

            jq --arg repo "$repo" --arg stack "$stack" \
              '. + [{repo:$repo, stack:$stack}]' "$OUT" > "$OUT.tmp"
            mv "$OUT.tmp" "$OUT"

            rm -rf "$tmpdir"
          done

          echo "Final stack report:"
          cat "$OUT"

      - name: Update README second <div> with stack report
        run: |
          set -euo pipefail

          python << 'EOF'
          import json
          import re
          from pathlib import Path

          # Load stack report JSON
          data = json.loads(Path("stack-report.json").read_text(encoding="utf-8"))

          # Build HTML table to embed into README
          rows = []
          for item in sorted(data, key=lambda x: x["repo"].lower()):
              repo = item.get("repo", "")
              stack = item.get("stack", "")
              rows.append(f'    <tr><td><code>{repo}</code></td><td>{stack}</td></tr>')

          table_block = (
              "<!-- STACK-REPORT-START -->\n"
              "<table>\n"
              "  <thead><tr><th>Repository</th><th>Stack</th></tr></thead>\n"
              "  <tbody>\n"
              + "\n".join(rows) + "\n"
              "  </tbody>\n"
              "</table>\n"
              "<!-- STACK-REPORT-END -->\n"
          )

          readme_path = Path("README.md")
          if not readme_path.exists():
              raise SystemExit("README.md not found in repo root")

          content = readme_path.read_text(encoding="utf-8")

          # Remove previous generated block if exists
          content = re.sub(
              r"<!-- STACK-REPORT-START -->.*?<!-- STACK-REPORT-END -->\\s*",
              "",
              content,
              flags=re.DOTALL,
          )

          # Find second <div ...> and insert table right after its opening tag
          matches = list(re.finditer(r"<div[^>]*>", content))
          if len(matches) < 2:
              raise SystemExit("README.md does not contain at least two <div> elements")

          second = matches[1]
          insert_pos = second.end()

          new_content = content[:insert_pos] + "\n\n" + table_block + "\n" + content[insert_pos:]

          readme_path.write_text(new_content, encoding="utf-8")
          EOF

      - name: Commit and push if README changed
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "chore: update stack report in README"
          git push
