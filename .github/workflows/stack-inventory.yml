name: Update Stack Inventory

on:
  schedule:
    - cron: "0 0 * * *" # Run daily at midnight UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  update-stack-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Update README after second <div> with stack report
        run: |
          set -euo pipefail

          python << 'EOF'
          import json
          import re
          from pathlib import Path
          from urllib.parse import quote

          # Load user color overrides (from badges README or wherever)
          colors_path = Path("badge-colors.json")
          try:
              user_colors = json.loads(colors_path.read_text(encoding="utf-8")) if colors_path.exists() else {}
          except Exception:
              user_colors = {}

          COLOR_MAP = {**DEFAULT_COLORS, **{k.lower(): v for k, v in user_colors.items()}}

          def normalize_dep(name: str) -> str:
              name = name.strip()
              if name.startswith("@"):
                  name = name[1:]
              parts = name.split("/")
              base = parts[-1] if parts else name
              return base.lower()

          def shields_url(label: str, key: str) -> str:
              label_q = quote(label.replace(" ", "_"))
              color = COLOR_MAP.get(key, "000000")  # default black if unknown
              logo_slug = quote(key)
              return (
                  f"https://img.shields.io/badge/{label_q}-{color}"
                  f"?style=flat&logo={logo_slug}&logoColor=white"
              )

          def badge_for(dep_name: str) -> str:
              key = normalize_dep(dep_name)
              url = shields_url(dep_name, key)
              return f'<img src="{url}" alt="{dep_name}" />'

          # Load stack report JSON
          report_path = Path("stack-report.json")
          if not report_path.exists():
              print("stack-report.json not found, aborting")
              raise SystemExit(0)

          data = json.loads(report_path.read_text(encoding="utf-8"))
          if not data:
              print("No data in stack-report.json, nothing to update")
              raise SystemExit(0)

          rows = []
          for item in sorted(data, key=lambda x: x["repo"].lower()):
              repo = item.get("repo", "")
              deps_raw = item.get("stack", "")
              if not deps_raw:
                  continue

              deps = [d.strip() for d in deps_raw.split(",") if d.strip()]
              if not deps:
                  continue

              badges_html = " ".join(badge_for(d) for d in deps)
              rows.append(
                  "    <tr>"
                  f"<td><code>{repo}</code></td>"
                  f"<td><p>{badges_html}</p></td>"
                  "</tr>"
              )

          if not rows:
              print("No rows to render, nothing to update")
              raise SystemExit(0)

          table_block = (
              "<!-- STACK-REPORT-START -->\n"
              "<table>\n"
              "  <thead><tr><th>Repository</th><th>Dependencies</th></tr></thead>\n"
              "  <tbody>\n"
              + "\n".join(rows) + "\n"
              "  </tbody>\n"
              "</table>\n"
              "<!-- STACK-REPORT-END -->\n"
          )

          readme_path = Path("README.md")
          if not readme_path.exists():
              raise SystemExit("README.md not found in repo root")

          content = readme_path.read_text(encoding="utf-8")

          # Remove previous generated block
          content = re.sub(
              r"<!-- STACK-REPORT-START -->.*?<!-- STACK-REPORT-END -->\\s*",
              "",
              content,
              flags=re.DOTALL,
          )

          # Insert AFTER the second <div>...</div> block
          blocks = list(re.finditer(r"<div[^>]*>[\\s\\S]*?</div>", content))
          if len(blocks) < 2:
              raise SystemExit("README.md does not contain at least two <div>...</div> blocks")

          second_block = blocks[1]
          insert_pos = second_block.end()

          new_content = content[:insert_pos] + "\n\n" + table_block + "\n" + content[insert_pos:]
          readme_path.write_text(new_content, encoding="utf-8")
          EOF

      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: GitHub Actions
          author_email: actions@github.com
          message: "Update stack inventory in README"
          add: "README.md"
